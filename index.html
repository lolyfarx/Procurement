<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YN-ERP v6.0 | شركة النهدي التجارية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --main-blue: #004a99; --main-orange: #f37021; --erp-bg: #f4f7fa; }
        body { font-family: 'Tajawal', sans-serif; background: var(--erp-bg); margin: 0; direction: rtl; }
        
        /* شاشة تسجيل الدخول */
        .login-overlay { position: fixed; inset: 0; background: var(--erp-bg); z-index: 20000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: #fff; width: 420px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); border-top: 10px solid var(--main-blue); padding: 40px; text-align: center; }
        
        /* الهيدر واللوجو */
        .erp-header { height: 75px; background: var(--main-blue); color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-center { position: absolute; left: 50%; transform: translateX(-50%); }
        .header-logo-img { height: 55px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        
        /* الهيكل الرئيسي */
        .erp-body { display: flex; min-height: calc(100vh - 75px); }
        .erp-sidebar { width: 280px; background: #fff; border-left: 1px solid #dee2e6; transition: 0.3s; position: relative; }
        .erp-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* القائمة الجانبية */
        .nav-item { display: flex; align-items: center; padding: 16px 28px; color: #555; text-decoration: none; border-right: 5px solid transparent; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .nav-item:hover { background: #f8fbff; color: var(--main-blue); }
        .nav-item.active { background: #eff6ff; color: var(--main-blue); border-right-color: var(--main-orange); }
        
        /* الكروت والإحصائيات */
        .stat-card { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 6px solid var(--main-blue); transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-val { font-size: 28px; font-weight: 800; color: var(--main-blue); }
        .stat-label { color: #777; font-weight: 600; margin-top: 5px; }
        
        .avatar { width: 45px; height: 45px; background: var(--main-orange); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #fff; font-size: 20px; }
        .price-col { background-color: #f0faff !important; font-weight: bold; }
        
        /* الجداول */
        .erp-main-table { border-radius: 15px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.03); }
        .erp-main-table thead { background: var(--main-blue); color: #fff; }
        
        @media (max-width: 991px) { .erp-sidebar { position: fixed; right: -280px; height: 100%; z-index: 1001; } .erp-sidebar.active { right: 0; } }
    </style>
</head>
<body>

    <div id="login-screen" class="login-overlay">
        <div class="login-card">
            <img src="logo.png" alt="YN Logo" style="width: 150px; margin-bottom: 25px;">
            <h3 class="fw-bold mb-4">بوابة الدخول الموحدة</h3>
            <div class="text-start mb-3">
                <label class="small fw-bold mb-1">اسم المستخدم</label>
                <input type="text" id="user-login" class="form-control form-control-lg" placeholder="ادخل اليوزر">
            </div>
            <div class="text-start mb-4">
                <label class="small fw-bold mb-1">كلمة المرور</label>
                <div class="input-group">
                    <input type="password" id="pass-login" class="form-control form-control-lg" placeholder="******">
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePass('pass-login', this)"><i class="bi bi-eye"></i></button>
                </div>
            </div>
            <button class="btn btn-primary w-100 p-3 fw-bold fs-5 shadow" onclick="handleLogin()">تسجيل الدخول</button>
            <div id="login-error" class="text-danger small mt-3" style="display:none; background:#fee2e2; padding:12px; border-radius:10px; font-weight: 700;">❌ خطأ في اسم المستخدم أو كلمة المرور!</div>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <header class="erp-header">
            <div class="header-left">
                <button class="btn text-white p-0" onclick="toggleSidebar()"><i class="bi bi-list fs-2"></i></button>
                <span class="ms-3 fw-bold fs-5 d-none d-md-inline">نظام الياسر ERP</span>
            </div>
            <div class="header-center"><img src="logo.png" alt="Logo" class="header-logo-img"></div>
            <div class="header-right d-flex align-items-center">
                <div class="text-end me-3">
                    <div id="display-user-name" class="fw-bold small">Admin</div>
                    <button class="btn-logout-link" onclick="location.reload()" style="background:none; border:none; color:#ffb3b3; font-size:11px; font-weight:bold; cursor:pointer;">تسجيل خروج</button>
                </div>
                <div class="avatar" id="user-avatar-initial">A</div>
            </div>
        </header>

        <div class="erp-body">
            <aside class="erp-sidebar" id="sidebar">
                <nav class="mt-4">
                    <div class="nav-item active" onclick="showTab('dashboard', this)"><i class="bi bi-speedometer2 me-3 fs-5"></i> لوحة التحكم</div>
                    <div class="nav-item" onclick="showTab('orders', this)"><i class="bi bi-cart-plus me-3 fs-5"></i> تحرير طلب شراء</div>
                    <div class="nav-item p-auth-users" onclick="showTab('settings', this)"><i class="bi bi-people me-3 fs-5"></i> إدارة المستخدمين</div>
                </nav>
            </aside>

            <main class="erp-content">
                <section id="tab-dashboard" class="tab-pane">
                    <div class="filter-box mb-4 p-4 bg-white rounded shadow-sm border-end border-5 border-primary">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="small fw-bold mb-2">النطاق الزمني</label>
                                <select id="dash-period" class="form-select" onchange="refreshDashboard()">
                                    <option value="today">اليوم</option>
                                    <option value="month" selected>هذا الشهر</option>
                                    <option value="year">هذه السنة</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="small fw-bold mb-2">الفلترة حسب القسم/الفرع</label>
                                <select id="dash-branch-filter" class="form-select" onchange="refreshDashboard()">
                                    <option value="all">كافة الفروع</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4 mb-5">
                        <div class="col-md-3"><div class="stat-card"><div class="stat-val" id="dash-total">0</div><div class="stat-label">إجمالي التكاليف (ر.س)</div></div></div>
                        <div class="col-md-3"><div class="stat-card" style="border-top-color: var(--main-orange);"><div class="stat-val" id="dash-count">0</div><div class="stat-label">عدد الطلبات</div></div></div>
                        <div class="col-md-3"><div class="stat-card" style="border-top-color: #10b981;"><div class="stat-val" id="dash-items">0</div><div class="stat-label">إجمالي القطع</div></div></div>
                    </div>
                    <div class="card p-4 border-0 shadow-sm" style="min-height: 450px;"><canvas id="mainChart"></canvas></div>
                </section>

                <section id="tab-orders" class="tab-pane" style="display:none;">
                    <div class="card p-4 border-0 shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                            <h4 class="fw-bold text-primary m-0">إنشاء طلب شراء (كفرات/جنوط)</h4>
                            <button class="btn btn-outline-dark btn-sm" onclick="window.print()"><i class="bi bi-printer me-1"></i> طباعة</button>
                        </div>
                        <div class="row g-3 mb-4 bg-light p-4 rounded-4">
                            <div class="col-md-6"><label class="small fw-bold">الفرع / القسم الطالب</label><select id="inp-dept" class="form-select"></select></div>
                            <div class="col-md-3"><label class="small fw-bold">المسؤول</label><input type="text" id="inp-user" class="form-control" readonly></div>
                            <div class="col-md-3"><label class="small fw-bold">تاريخ الطلب</label><input type="text" id="inp-date" class="form-control" readonly></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table erp-main-table align-middle">
                                <thead>
                                    <tr>
                                        <th>البراند</th>
                                        <th width="320">المقاس (العرض W / الارتفاع H / القطر R)</th>
                                        <th width="100">الكمية</th>
                                        <th class="p-auth-cost">التكلفة للوحدة</th>
                                        <th class="p-auth-cost">الإجمالي</th>
                                        <th>#</th>
                                    </tr>
                                </thead>
                                <tbody id="order-rows"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-outline-primary fw-bold mt-2" onclick="createNewRow()">+ إضافة صنف جديد</button>
                        <div class="text-end mt-4 p-4 bg-dark text-white rounded-4 shadow">
                            <h3 class="m-0 fw-bold">الإجمالي العام: <span id="grand-total" class="text-warning">0.00</span> ر.س</h3>
                        </div>
                        <button class="btn btn-primary w-100 p-3 mt-4 fw-bold fs-5 shadow" onclick="saveOrder()">حفظ الطلب وإرساله للسحابة</button>
                    </div>
                </section>

                <section id="tab-settings" class="tab-pane" style="display:none;">
                    <div class="card p-4 border-0 shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold m-0">قاعدة بيانات المستخدمين والصلاحيات</h5>
                            <button class="btn btn-success fw-bold" onclick="openUserModal()">+ إضافة موظف جديد</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover text-center">
                                <thead class="table-light"><tr><th>المستخدم</th><th>القسم</th><th>الوظيفة</th><th>الصلاحيات</th><th>الإجراء</th></tr></thead>
                                <tbody id="users-table"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg shadow-lg">
            <div class="modal-content border-0 rounded-4">
                <div class="modal-header bg-primary text-white p-4"><h5 class="fw-bold m-0">إعداد بيانات المستخدم</h5></div>
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6"><label class="small fw-bold">اسم المستخدم</label><input type="text" id="u-name" class="form-control"></div>
                        <div class="col-md-6"><label class="small fw-bold">كلمة السر</label><input type="text" id="u-pass" class="form-control"></div>
                        <div class="col-md-6"><label class="small fw-bold">القسم</label><select id="u-dept" class="form-select"></select></div>
                        <div class="col-md-6"><label class="small fw-bold">المسمى الوظيفي</label><input type="text" id="u-job" class="form-control"></div>
                    </div>
                    <hr class="my-4">
                    <h6 class="fw-bold mb-3">تفعيل الصلاحيات:</h6>
                    <div class="d-flex gap-4">
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="auth-cost-check"><label class="form-check-label">رؤية التكاليف</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="auth-users-check"><label class="form-check-label">إدارة المستخدمين</label></div>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary px-5 fw-bold" onclick="saveUserToDB()">حفظ البيانات</button></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. إعدادات الأمان والمستخدمين (Admin الإجباري) ---
        const MASTER_ADMIN = { name: "admin", pass: "@Mm123321", job: "المدير العام", dept: "الإدارة العليا", auths: { cost: true, users: true } };
        let usersDB = JSON.parse(localStorage.getItem('erp_users')) || [MASTER_ADMIN];
        let currentUser = null;
        let ordersDB = JSON.parse(localStorage.getItem('erp_all_orders')) || [];
        const branches = Array.from({length: 21}, (_, i) => `فرع النهدي ${i + 1}`);
        const depts = ["قسم الشركات", "قسم الاستيراد", "قسم الجملة", "إدارة المشتريات", ...branches];

        // --- 2. نظام الدخول ---
        function togglePass(id, btn) {
            const inp = document.getElementById(id);
            const icon = btn.querySelector('i');
            if(inp.type === "password") { inp.type = "text"; icon.className = "bi bi-eye-slash"; }
            else { inp.type = "password"; icon.className = "bi bi-eye"; }
        }

        function handleLogin() {
            const u = document.getElementById('user-login').value.trim();
            const p = document.getElementById('pass-login').value.trim();
            const err = document.getElementById('login-error');

            // البحث عن المستخدم (الأدمن أو الموظفين المضافين)
            const found = usersDB.find(user => user.name === u && user.pass === p);

            if (found) {
                currentUser = found;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                initApp();
            } else {
                err.style.display = 'block';
            }
        }

        // --- 3. تهيئة التطبيق ---
        function initApp() {
            // تعبئة الفروع
            const sel = document.getElementById('inp-dept');
            const dashSel = document.getElementById('dash-branch-filter');
            const userDeptSel = document.getElementById('u-dept');
            
            depts.forEach(d => {
                sel.add(new Option(d, d));
                dashSel.add(new Option(d, d));
                userDeptSel.add(new Option(d, d));
            });

            document.getElementById('inp-user').value = currentUser.name;
            document.getElementById('display-user-name').innerText = currentUser.name;
            document.getElementById('user-avatar-initial').innerText = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('inp-date').value = new Date().toLocaleDateString('ar-SA');

            applyPermissions();
            refreshDashboard();
            renderUsersList();
            createNewRow();
        }

        function applyPermissions() {
            if (currentUser.name === "admin") return;
            if (!currentUser.auths.cost) {
                document.querySelectorAll('.p-auth-cost').forEach(el => el.style.display = 'none');
            }
            if (!currentUser.auths.users) {
                document.querySelectorAll('.p-auth-users').forEach(el => el.style.display = 'none');
            }
        }

        // --- 4. إدارة الجداول (المقاسات الثلاثية) ---
        function createNewRow() {
            const body = document.getElementById('order-rows');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="form-control" placeholder="البراند"></td>
                <td><div class="d-flex gap-1">
                    <input type="text" class="form-control text-center" placeholder="W" title="العرض">
                    <input type="text" class="form-control text-center" placeholder="H" title="الارتفاع">
                    <input type="text" class="form-control text-center" placeholder="R" title="القطر">
                </div></td>
                <td><input type="number" class="form-control qty" value="1" onchange="calc()"></td>
                <td class="p-auth-cost"><input type="number" class="form-control cost" value="0" onchange="calc()"></td>
                <td class="p-auth-cost fw-bold text-primary row-total">0.00</td>
                <td><button class="btn btn-sm text-danger fs-5" onclick="this.closest('tr').remove(); calc();">×</button></td>
            `;
            body.appendChild(tr);
            applyPermissions();
        }

        function calc() {
            let grand = 0, totalItems = 0;
            document.querySelectorAll('#order-rows tr').forEach(row => {
                const q = parseFloat(row.querySelector('.qty').value) || 0;
                const c = parseFloat(row.querySelector('.cost').value) || 0;
                const total = q * c;
                row.querySelector('.row-total').innerText = total.toFixed(2);
                grand += total;
                totalItems += q;
            });
            document.getElementById('grand-total').innerText = grand.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('dash-items').innerText = totalItems;
        }

        function saveOrder() {
            const total = parseFloat(document.getElementById('grand-total').innerText.replace(/,/g, ''));
            if(total <= 0) return alert("الطلب فارغ!");
            
            const newOrder = {
                branch: document.getElementById('inp-dept').value,
                total: total,
                qty: parseInt(document.getElementById('dash-items').innerText),
                date: new Date().toISOString(),
                user: currentUser.name
            };
            ordersDB.push(newOrder);
            localStorage.setItem('erp_all_orders', JSON.stringify(ordersDB));
            alert("✅ تم حفظ الطلب بنجاح!");
            document.getElementById('order-rows').innerHTML = "";
            createNewRow();
            refreshDashboard();
        }

        // --- 5. لوحة التحكم والبيانات ---
        function refreshDashboard() {
            const period = document.getElementById('dash-period').value;
            const branch = document.getElementById('dash-branch-filter').value;
            const now = new Date();

            let filtered = ordersDB.filter(o => {
                const oDate = new Date(o.date);
                const matchBranch = (branch === 'all' || o.branch === branch);
                if (period === 'today') return matchBranch && oDate.toDateString() === now.toDateString();
                if (period === 'month') return matchBranch && oDate.getMonth() === now.getMonth();
                return matchBranch;
            });

            document.getElementById('dash-total').innerText = filtered.reduce((s,o)=>s+o.total, 0).toLocaleString();
            document.getElementById('dash-count').innerText = filtered.length;
            renderChart(filtered);
        }

        function renderChart(data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(o => new Date(o.date).toLocaleDateString('ar-SA')),
                    datasets: [{ label: 'قيمة الطلبات', data: data.map(o => o.total), borderColor: '#004a99', backgroundColor: 'rgba(0,74,153,0.1)', fill: true, tension: 0.3 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- 6. إدارة المستخدمين ---
        function renderUsersList() {
            const table = document.getElementById('users-table');
            table.innerHTML = "";
            usersDB.forEach((u, i) => {
                table.innerHTML += `<tr>
                    <td class="fw-bold">${u.name}</td>
                    <td>${u.dept}</td>
                    <td>${u.job}</td>
                    <td><span class="badge ${u.auths.cost ? 'bg-success':'bg-secondary'}">تكلفة</span> <span class="badge ${u.auths.users ? 'bg-info':'bg-secondary'}">إدارة</span></td>
                    <td>${u.name !== "admin" ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${i})"><i class="bi bi-trash"></i></button>` : '---'}</td>
                </tr>`;
            });
        }

        function openUserModal() {
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function saveUserToDB() {
            const newUser = {
                name: document.getElementById('u-name').value,
                pass: document.getElementById('u-pass').value,
                dept: document.getElementById('u-dept').value,
                job: document.getElementById('u-job').value,
                auths: {
                    cost: document.getElementById('auth-cost-check').checked,
                    users: document.getElementById('auth-users-check').checked
                }
            };
            usersDB.push(newUser);
            localStorage.setItem('erp_users', JSON.stringify(usersDB));
            renderUsersList();
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
        }

        function deleteUser(i) {
            if(confirm("حذف الموظف؟")) { usersDB.splice(i, 1); localStorage.setItem('erp_users', JSON.stringify(usersDB)); renderUsersList(); }
        }

        function showTab(id, btn) {
            document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
            document.getElementById('tab-' + id).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>