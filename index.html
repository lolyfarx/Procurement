<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YN-ERP v5.0 | شركة النهدي التجارية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --main-blue: #004a99; --main-orange: #f37021; --erp-bg: #f4f7fa; }
        body { font-family: 'Tajawal', sans-serif; background: var(--erp-bg); margin: 0; direction: rtl; }
        
        /* شاشة الدخول */
        .login-overlay { position: fixed; inset: 0; background: var(--erp-bg); z-index: 20000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: #fff; width: 400px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border-top: 8px solid var(--main-blue); padding: 30px; text-align: center; }
        
        /* الهيدر واللوجو */
        .erp-header { height: 70px; background: var(--main-blue); color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; position: sticky; top: 0; z-index: 1000; }
        .header-center { position: absolute; left: 50%; transform: translateX(-50%); }
        .header-logo-img { height: 50px; object-fit: contain; }
        
        /* التنسيقات العامة */
        .erp-body { display: flex; min-height: calc(100vh - 70px); }
        .erp-sidebar { width: 260px; background: #fff; border-left: 1px solid #ddd; transition: 0.3s; }
        .erp-content { flex: 1; padding: 20px; }
        .nav-item { display: flex; align-items: center; padding: 15px 25px; color: #444; text-decoration: none; border-right: 5px solid transparent; font-weight: 600; cursor: pointer; }
        .nav-item.active { background: #f0f7ff; color: var(--main-blue); border-right-color: var(--main-orange); }
        .stat-card { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-top: 5px solid var(--main-blue); }
        .stat-val { font-size: 24px; font-weight: 800; }
        .avatar { width: 40px; height: 40px; background: var(--main-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .btn-logout-link { background: none; border: none; color: #ffcccc; font-size: 12px; text-decoration: underline; cursor: pointer; }

        @media (max-width: 991px) { .erp-sidebar { display: none; } }
    </style>
</head>
<body>

    <div id="login-screen" class="login-overlay">
        <div class="login-card">
            <img src="logo.png" alt="YN Logo" style="width: 140px; margin-bottom: 20px;">
            <h4 class="fw-bold mb-4">بوابة الدخول الموحدة</h4>
            <div class="text-start mb-3">
                <label class="small fw-bold">اسم المستخدم</label>
                <input type="text" id="user-login" class="form-control" placeholder="admin">
            </div>
            <div class="text-start mb-4">
                <label class="small fw-bold">كلمة المرور</label>
                <div class="input-group">
                    <input type="password" id="pass-login" class="form-control" placeholder="@Mm123321">
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePass('pass-login', this)"><i class="bi bi-eye"></i></button>
                </div>
            </div>
            <button class="btn btn-primary w-100 p-2 fw-bold" onclick="handleLogin()">تسجيل الدخول</button>
            <div id="login-error" class="text-danger small mt-3" style="display:none; background:#fee2e2; padding:10px; border-radius:8px;">❌ خطأ في البيانات!</div>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <header class="erp-header">
            <div class="header-left">
                <button class="btn text-white" onclick="toggleSidebar()"><i class="bi bi-list fs-3"></i></button>
                <span class="ms-2 fw-bold">YN-ERP</span>
            </div>
            <div class="header-center"><img src="logo.png" alt="Logo" class="header-logo-img"></div>
            <div class="header-right d-flex align-items-center">
                <div class="text-end me-3">
                    <div id="display-user-name" class="fw-bold small">Admin</div>
                    <button class="btn-logout-link" onclick="location.reload()">خروج</button>
                </div>
                <div class="avatar" id="user-avatar-initial">A</div>
            </div>
        </header>

        <div class="erp-body">
            <aside class="erp-sidebar" id="sidebar">
                <nav class="mt-4">
                    <div class="nav-item active" onclick="showTab('dashboard', this)"><i class="bi bi-speedometer2 me-2"></i> لوحة التحكم</div>
                    <div class="nav-item" onclick="showTab('orders', this)"><i class="bi bi-cart-plus me-2"></i> طلب شراء</div>
                    <div class="nav-item p-auth-users" onclick="showTab('settings', this)"><i class="bi bi-gear me-2"></i> الإعدادات</div>
                </nav>
            </aside>

            <main class="erp-content">
                <section id="tab-dashboard" class="tab-pane">
                    <div class="row g-3 mb-4">
                        <div class="col-md-3"><div class="stat-card"><div class="stat-val" id="dash-total">0</div><div class="small">إجمالي التكاليف</div></div></div>
                        <div class="col-md-3"><div class="stat-card" style="border-top-color: var(--main-orange);"><div class="stat-val" id="dash-count">0</div><div class="small">عدد الطلبات</div></div></div>
                    </div>
                    <div class="card p-4 border-0 shadow-sm" style="height: 400px;"><canvas id="mainChart"></canvas></div>
                </section>

                <section id="tab-orders" class="tab-pane" style="display:none;">
                    <div class="card p-4 border-0 shadow-sm">
                        <h5 class="fw-bold mb-4">تحرير طلب شراء جديد</h5>
                        <div class="row g-3 mb-4 bg-light p-3 rounded">
                            <div class="col-md-4"><label class="small fw-bold">الفرع</label><select id="inp-dept" class="form-select"></select></div>
                            <div class="col-md-4"><label class="small fw-bold">المسؤول</label><input type="text" id="inp-user" class="form-control" readonly></div>
                        </div>
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th>البراند</th>
                                    <th width="300">المقاس (W/H/R)</th>
                                    <th>الكمية</th>
                                    <th class="p-auth-cost">التكلفة</th>
                                    <th class="p-auth-cost">الإجمالي</th>
                                    <th>#</th>
                                </tr>
                            </thead>
                            <tbody id="order-rows"></tbody>
                        </table>
                        <button class="btn btn-outline-primary btn-sm mb-4" onclick="createNewRow()">+ إضافة صنف</button>
                        <div class="text-end mb-3">
                            <h4 class="fw-bold">الإجمالي: <span id="grand-total">0.00</span> ر.س</h4>
                        </div>
                        <button class="btn btn-primary w-100 p-3 fw-bold" onclick="saveOrder()">حفظ وإرسال الطلب</button>
                    </div>
                </section>

                <section id="tab-settings" class="tab-pane" style="display:none;">
                    <div class="card p-4 border-0 shadow-sm">
                        <h5 class="fw-bold">إدارة المستخدمين</h5>
                        <table class="table mt-3">
                            <thead><tr><th>المستخدم</th><th>القسم</th><th>الإجراء</th></tr></thead>
                            <tbody id="users-table"></tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        // بيانات الأدمن الثابتة (لضمان الدخول)
        const ADMIN_DATA = { name: "admin", pass: "@Mm123321", auths: { cost: true, users: true } };
        let currentUser = null;
        let orders = JSON.parse(localStorage.getItem('erp_orders')) || [];
        const branches = Array.from({length: 21}, (_, i) => `فرع النهدي ${i + 1}`);

        function togglePass(id, btn) {
            const inp = document.getElementById(id);
            const icon = btn.querySelector('i');
            if(inp.type === "password") { inp.type = "text"; icon.className = "bi bi-eye-slash"; }
            else { inp.type = "password"; icon.className = "bi bi-eye"; }
        }

        function handleLogin() {
            const u = document.getElementById('user-login').value.trim();
            const p = document.getElementById('pass-login').value.trim();
            const err = document.getElementById('login-error');

            // تحقق مباشر وصارم
            if (u === ADMIN_DATA.name && p === ADMIN_DATA.pass) {
                currentUser = ADMIN_DATA;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                initApp();
            } else {
                err.style.display = 'block';
            }
        }

        function initApp() {
            const sel = document.getElementById('inp-dept');
            branches.forEach(b => sel.add(new Option(b, b)));
            document.getElementById('inp-user').value = currentUser.name;
            document.getElementById('display-user-name').innerText = currentUser.name;
            createNewRow();
            updateDash();
        }

        function createNewRow() {
            const body = document.getElementById('order-rows');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="form-control"></td>
                <td><div class="d-flex gap-1">
                    <input type="text" class="form-control text-center" placeholder="W">
                    <input type="text" class="form-control text-center" placeholder="H">
                    <input type="text" class="form-control text-center" placeholder="R">
                </div></td>
                <td><input type="number" class="form-control qty" value="1" onchange="calc()"></td>
                <td class="p-auth-cost"><input type="number" class="form-control cost" value="0" onchange="calc()"></td>
                <td class="p-auth-cost fw-bold row-total">0.00</td>
                <td><button class="btn text-danger" onclick="this.closest('tr').remove(); calc();">×</button></td>
            `;
            body.appendChild(tr);
        }

        function calc() {
            let grand = 0;
            document.querySelectorAll('#order-rows tr').forEach(row => {
                const q = row.querySelector('.qty').value;
                const c = row.querySelector('.cost').value;
                const total = q * c;
                row.querySelector('.row-total').innerText = total.toFixed(2);
                grand += total;
            });
            document.getElementById('grand-total').innerText = grand.toLocaleString();
        }

        function saveOrder() {
            const total = parseFloat(document.getElementById('grand-total').innerText.replace(/,/g, ''));
            orders.push({ total: total, date: new Date().toISOString() });
            localStorage.setItem('erp_orders', JSON.stringify(orders));
            alert("تم الحفظ بنجاح");
            updateDash();
        }

        function updateDash() {
            document.getElementById('dash-total').innerText = orders.reduce((s,o)=>s+o.total, 0).toLocaleString();
            document.getElementById('dash-count').innerText = orders.length;
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: orders.map(o => new Date(o.date).toLocaleDateString()),
                    datasets: [{ label: 'المبيعات', data: orders.map(o => o.total), borderColor: '#004a99' }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function showTab(id, btn) {
            document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
            document.getElementById('tab-' + id).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleSidebar() {
            const s = document.getElementById('sidebar');
            s.style.display = (s.style.display === 'none' || s.style.display === '') ? 'block' : 'none';
        }
    </script>
</body>
</html>