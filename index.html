<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YN-ERP v6.2 | شركة النهدي التجارية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --main-blue: #004a99; --main-orange: #f37021; --erp-bg: #f4f7fa; }
        body { font-family: 'Tajawal', sans-serif; background: var(--erp-bg); margin: 0; direction: rtl; }
        
        /* شاشة الدخول */
        .login-overlay { position: fixed; inset: 0; background: var(--erp-bg); z-index: 20000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: #fff; width: 420px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); border-top: 10px solid var(--main-blue); padding: 40px; text-align: center; }
        
        /* الهيدر واللوجو */
        .erp-header { height: 75px; background: var(--main-blue); color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; position: sticky; top: 0; z-index: 1000; }
        .header-center { position: absolute; left: 50%; transform: translateX(-50%); }
        .header-logo-img { height: 55px; }
        
        /* الهيكل */
        .erp-body { display: flex; min-height: calc(100vh - 75px); }
        .erp-sidebar { width: 280px; background: #fff; border-left: 1px solid #dee2e6; }
        .erp-content { flex: 1; padding: 30px; }
        
        .nav-item { display: flex; align-items: center; padding: 16px 28px; color: #555; text-decoration: none; border-right: 5px solid transparent; font-weight: 700; cursor: pointer; }
        .nav-item.active { background: #eff6ff; color: var(--main-blue); border-right-color: var(--main-orange); }
        
        .stat-card { background: #fff; padding: 25px; border-radius: 20px; border-top: 6px solid var(--main-blue); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .stat-val { font-size: 28px; font-weight: 800; color: var(--main-blue); }
        .avatar { width: 45px; height: 45px; background: var(--main-orange); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #fff; }
        
        @media (max-width: 991px) { .erp-sidebar { display: none; } }
    </style>
</head>
<body>

    <div id="login-screen" class="login-overlay">
        <div class="login-card">
            <img src="logo.png" alt="YN Logo" style="width: 150px; margin-bottom: 25px;">
            <h3 class="fw-bold mb-4">بوابة الدخول الموحدة</h3>
            <div class="text-start mb-3">
                <label class="small fw-bold mb-1">اسم المستخدم</label>
                <input type="text" id="user-login" class="form-control form-control-lg" placeholder="admin">
            </div>
            <div class="text-start mb-4">
                <label class="small fw-bold mb-1">كلمة المرور</label>
                <div class="input-group">
                    <input type="password" id="pass-login" class="form-control form-control-lg" placeholder="******">
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePass('pass-login', this)"><i class="bi bi-eye"></i></button>
                </div>
            </div>
            <button class="btn btn-primary w-100 p-3 fw-bold fs-5 shadow" onclick="handleLogin()">تسجيل الدخول</button>
            <div id="login-error" class="text-danger small mt-3" style="display:none; background:#fee2e2; padding:12px; border-radius:10px; font-weight: 700;">❌ خطأ في اسم المستخدم أو كلمة المرور!</div>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <header class="erp-header">
            <div class="header-left">
                <button class="btn text-white p-0" onclick="toggleSidebar()"><i class="bi bi-list fs-2"></i></button>
                <span class="ms-3 fw-bold fs-5">YN-ERP v6.2</span>
            </div>
            <div class="header-center"><img src="logo.png" alt="Logo" class="header-logo-img"></div>
            <div class="header-right d-flex align-items-center">
                <div class="text-end me-3">
                    <div id="display-user-name" class="fw-bold small">Admin</div>
                    <button onclick="location.reload()" style="background:none; border:none; color:#ffb3b3; font-size:11px; font-weight:bold; cursor:pointer;">تسجيل خروج</button>
                </div>
                <div class="avatar" id="user-avatar-initial">A</div>
            </div>
        </header>

        <div class="erp-body">
            <aside class="erp-sidebar" id="sidebar">
                <nav class="mt-4">
                    <div class="nav-item active" onclick="showTab('dashboard', this)"><i class="bi bi-speedometer2 me-3 fs-5"></i> لوحة التحكم</div>
                    <div class="nav-item" onclick="showTab('orders', this)"><i class="bi bi-cart-plus me-3 fs-5"></i> طلب شراء</div>
                    <div class="nav-item p-auth-users" onclick="showTab('settings', this)"><i class="bi bi-people me-3 fs-5"></i> إدارة المستخدمين</div>
                </nav>
            </aside>

            <main class="erp-content">
                <section id="tab-dashboard" class="tab-pane">
                    <div class="row g-4 mb-5">
                        <div class="col-md-4"><div class="stat-card"><div class="stat-val" id="dash-total">0</div><div class="stat-label">إجمالي التكاليف (ر.س)</div></div></div>
                        <div class="col-md-4"><div class="stat-card" style="border-top-color: var(--main-orange);"><div class="stat-val" id="dash-count">0</div><div class="stat-label">عدد الطلبات</div></div></div>
                        <div class="col-md-4"><div class="stat-card" style="border-top-color: #10b981;"><div class="stat-val" id="dash-items">0</div><div class="stat-label">إجمالي القطع</div></div></div>
                    </div>
                    <div class="card p-4 border-0 shadow-sm" style="min-height: 400px;"><canvas id="mainChart"></canvas></div>
                </section>

                <section id="tab-orders" class="tab-pane" style="display:none;">
                    <div class="card p-4 border-0 shadow-sm">
                        <h4 class="fw-bold text-primary mb-4 border-bottom pb-2">تحرير طلب شراء جديد</h4>
                        <div class="row g-3 mb-4 bg-light p-4 rounded-4">
                            <div class="col-md-6"><label class="small fw-bold">الفرع / القسم</label><select id="inp-dept" class="form-select"></select></div>
                            <div class="col-md-6"><label class="small fw-bold">المسؤول</label><input type="text" id="inp-user" class="form-control" readonly></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th>البراند</th>
                                        <th width="320">المقاس (W / H / R)</th>
                                        <th width="100">الكمية</th>
                                        <th class="p-auth-cost">التكلفة</th>
                                        <th class="p-auth-cost">الإجمالي</th>
                                        <th>#</th>
                                    </tr>
                                </thead>
                                <tbody id="order-rows"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-outline-primary fw-bold" onclick="createNewRow()">+ إضافة صنف جديد</button>
                        <div class="text-end mt-4 p-4 bg-dark text-white rounded-4 shadow">
                            <h3 class="m-0">الإجمالي العام: <span id="grand-total" class="text-warning">0.00</span> ر.س</h3>
                        </div>
                        <button class="btn btn-primary w-100 p-3 mt-4 fw-bold fs-5 shadow" onclick="saveOrder()">حفظ وإرسال الطلب</button>
                    </div>
                </section>

                <section id="tab-settings" class="tab-pane" style="display:none;">
                    <div class="card p-4 border-0 shadow-sm">
                        <div class="d-flex justify-content-between mb-4">
                            <h5 class="fw-bold m-0">قاعدة بيانات المستخدمين</h5>
                            <button class="btn btn-success btn-sm" onclick="openUserModal()">+ إضافة مستخدم جديد</button>
                        </div>
                        <table class="table">
                            <thead><tr><th>المستخدم</th><th>القسم</th><th>الإجراء</th></tr></thead>
                            <tbody id="users-table"></tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content p-3">
            <h5 class="fw-bold mb-3">إضافة مستخدم جديد</h5>
            <input type="text" id="u-name" class="form-control mb-2" placeholder="اسم المستخدم">
            <input type="text" id="u-pass" class="form-control mb-2" placeholder="كلمة السر">
            <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="u-cost-auth"><label class="form-check-label small">عرض التكلفة</label></div>
            <button class="btn btn-primary w-100" onclick="saveUserToDB()">حفظ البيانات</button>
        </div></div></div>
    </div>

    <script>
        // --- البيانات الأساسية ---
        const MASTER_ADMIN = { name: "admin", pass: "@Mm123321", auths: { cost: true, users: true } };
        let usersDB = JSON.parse(localStorage.getItem('erp_users')) || [MASTER_ADMIN];
        let ordersDB = JSON.parse(localStorage.getItem('erp_all_orders')) || [];
        let currentUser = null;
        const branches = Array.from({length: 21}, (_, i) => `فرع النهدي ${i + 1}`);

        function togglePass(id, btn) {
            const inp = document.getElementById(id);
            const icon = btn.querySelector('i');
            if(inp.type === "password") { inp.type = "text"; icon.className = "bi bi-eye-slash"; }
            else { inp.type = "password"; icon.className = "bi bi-eye"; }
        }

        // --- دالة الدخول (المصلحة نهائياً) ---
        function handleLogin() {
            const uInput = document.getElementById('user-login').value.trim();
            const pInput = document.getElementById('pass-login').value.trim();
            const err = document.getElementById('login-error');

            // 1. تحقق مباشر من الأدمن (الصلب) لضمان الدخول حتى لو فشلت الذاكرة
            if (uInput === MASTER_ADMIN.name && pInput === MASTER_ADMIN.pass) {
                currentUser = MASTER_ADMIN;
            } else {
                // 2. البحث في المستخدمين المضافين
                const found = usersDB.find(user => user.name === uInput && user.pass === pInput);
                if (found) currentUser = found;
            }

            if (currentUser) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                initApp();
            } else {
                err.style.display = 'block';
            }
        }

        function initApp() {
            const sel = document.getElementById('inp-dept');
            if(sel.options.length === 0) branches.forEach(b => sel.add(new Option(b, b)));
            
            document.getElementById('inp-user').value = currentUser.name;
            document.getElementById('display-user-name').innerText = currentUser.name;
            document.getElementById('user-avatar-initial').innerText = currentUser.name.charAt(0).toUpperCase();
            
            // إخفاء إدارة المستخدمين لغير الأدمن
            if (currentUser.name !== "admin" && !currentUser.auths.users) {
                document.querySelector('.p-auth-users').style.display = 'none';
            }

            refreshDashboard();
            renderUsersList();
            if(document.getElementById('order-rows').children.length === 0) createNewRow();
        }

        function createNewRow() {
            const body = document.getElementById('order-rows');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="form-control" placeholder="البراند"></td>
                <td><div class="d-flex gap-1">
                    <input type="text" class="form-control text-center" placeholder="W">
                    <input type="text" class="form-control text-center" placeholder="H">
                    <input type="text" class="form-control text-center" placeholder="R">
                </div></td>
                <td><input type="number" class="form-control qty" value="1" onchange="calc()"></td>
                <td class="p-auth-cost"><input type="number" class="form-control cost" value="0" onchange="calc()"></td>
                <td class="p-auth-cost fw-bold text-primary row-total">0.00</td>
                <td><button class="btn text-danger fs-5" onclick="this.closest('tr').remove(); calc();">×</button></td>
            `;
            body.appendChild(tr);
            applyUIPerms();
        }

        function applyUIPerms() {
            if(currentUser && !currentUser.auths.cost) {
                document.querySelectorAll('.p-auth-cost').forEach(el => el.style.display = 'none');
            }
        }

        function calc() {
            let grand = 0, items = 0;
            document.querySelectorAll('#order-rows tr').forEach(row => {
                const q = parseFloat(row.querySelector('.qty').value) || 0;
                const c = parseFloat(row.querySelector('.cost').value) || 0;
                const total = q * c;
                row.querySelector('.row-total').innerText = total.toFixed(2);
                grand += total; items += q;
            });
            document.getElementById('grand-total').innerText = grand.toLocaleString();
            document.getElementById('dash-items').innerText = items;
        }

        function saveOrder() {
            const total = parseFloat(document.getElementById('grand-total').innerText.replace(/,/g, ''));
            ordersDB.push({ branch: document.getElementById('inp-dept').value, total: total, date: new Date().toISOString() });
            localStorage.setItem('erp_all_orders', JSON.stringify(ordersDB));
            alert("✅ تم الحفظ بنجاح");
            refreshDashboard();
        }

        function refreshDashboard() {
            document.getElementById('dash-total').innerText = ordersDB.reduce((s,o)=>s+o.total, 0).toLocaleString();
            document.getElementById('dash-count').innerText = ordersDB.length;
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ordersDB.slice(-10).map(o => new Date(o.date).toLocaleDateString()),
                    datasets: [{ label: 'قيمة الطلبات', data: ordersDB.slice(-10).map(o => o.total), borderColor: '#004a99', tension: 0.3 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderUsersList() {
            const table = document.getElementById('users-table');
            table.innerHTML = "";
            usersDB.forEach((u, i) => {
                table.innerHTML += `<tr><td>${u.name}</td><td>${u.dept || 'فرع'}</td><td>
                    ${u.name !== 'admin' ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${i})">حذف</button>` : '-'}
                </td></tr>`;
            });
        }

        function openUserModal() { new bootstrap.Modal(document.getElementById('userModal')).show(); }

        function saveUserToDB() {
            usersDB.push({ 
                name: document.getElementById('u-name').value, 
                pass: document.getElementById('u-pass').value, 
                auths: { cost: document.getElementById('u-cost-auth').checked, users: false } 
            });
            localStorage.setItem('erp_users', JSON.stringify(usersDB));
            renderUsersList();
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
        }

        function deleteUser(i) {
            usersDB.splice(i, 1);
            localStorage.setItem('erp_users', JSON.stringify(usersDB));
            renderUsersList();
        }

        function showTab(id, btn) {
            document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
            document.getElementById('tab-' + id).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>